#!/bin/bash -x

set -e

apt install --no-install-recommends -y gnome-initial-setup provd

mv /usr/share/applications/gnome-initial-setup.desktop /usr/share/applications/ubuntu-core-desktop-init.desktop
sed -i 's#/usr/libexec/gnome-initial-setup#/usr/libexec/launch-desktop-provision-init#g' /usr/share/applications/ubuntu-core-desktop-init.desktop

sed -i 's#gnome-initial-setup#ubuntu-core-desktop-init#g' /usr/share/gnome-session/sessions/gnome-initial-setup.session

cat > /usr/libexec/launch-desktop-provision-init << EOF
#!/bin/sh

# Create the /run/gnome-initial-setup/desktop-provision directory
mkdir -p /run/gnome-initial-setup/desktop-provision

# Create the /run/gnome-initial-setup/.cache directory
mkdir -p /run/gnome-initial-setup/.cache

/usr/libexec/provd &
until [ -S /run/gnome-initial-setup/desktop-provision/init.socket ]; do
	sleep 1
done

env DBUS_SESSION_BUS_ADDRESS="unix:path=\$XDG_RUNTIME_DIR/bus" WAYLAND_DISPLAY=\$XDG_RUNTIME_DIR/wayland-0 DESKTOP_PROVISION_PATH=/usr/share/desktop-provision /snap/ubuntu-desktop-init/current/bin/ubuntu_init

EOF

mkdir -p /usr/share/desktop-provision

cat > /usr/share/desktop-provision/whitelabel.yaml << EOF
mode: core-desktop
pages:
  eula:
    visible: false
  ubuntu-pro-onboarding:
    visible: false
  accessibility:
    # The a11y page is non-functional without sprovd. It's also not
    # clear it placed settings in a place the ubuntu-desktop-session
    # snap would see them.
    visible: false
  privacy:
    visible: false
EOF


# remove unneeded files to free space
rm -f /usr/lib/systemd/user/gnome-session.target.wants/gnome-initial-setup-copy-worker.service
rm -f /usr/lib/systemd/user/gnome-session.target.wants/gnome-initial-setup-first-login.service
rm -f /usr/share/gnome-initial-setup/vendor.conf
rm -rf /usr/share/doc/gnome-initial-setup
rm -f /usr/libexec/gnome-initial-setup*
rm -f /usr/lib/systemd/user/gnome-initial-setup-copy-worker.service
rm -f /usr/lib/systemd/user/gnome-initial-setup-first-login.service
rm -f /etc/xdg/autostart/gnome-initial-setup-copy-worker.desktop
rm -f /etc/xdg/autostart/gnome-initial-setup-first-login.desktop

# configure the Ubuntu theme colors for the initial session
sed -i '2 i "stylesheetName": "Yaru/gnome-shell.css",' /usr/share/gnome-shell/modes/initial-setup.json
sed -i '3 i "colorScheme": "prefer-light",' /usr/share/gnome-shell/modes/initial-setup.json
sed -i '4 i "themeResourceName": "theme/Yaru/gnome-shell-theme.gresource",' /usr/share/gnome-shell/modes/initial-setup.json
sed -i '5 i "iconsResourceName": "theme/Yaru/gnome-shell-icons.gresource",' /usr/share/gnome-shell/modes/initial-setup.json

mv /init-default.compiled /usr/share/gnome-initial-setup/initial-setup-dconf-defaults
